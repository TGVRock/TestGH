import{C as a,q as h,s as A,v,x as y,u as C,a as R,j as i}from"./index-3663960e.js";function F(e){return e?"true":"false"}function H(e){return e.toLocaleString("en")}function S(e,t){return e*1e3+Number(t.toString())}function B(e,t){switch(t){case h.Fast:return e.averageFeeMultiplier;case h.Average:return e.minFeeMultiplier+e.averageFeeMultiplier*.65;case h.Slow:return e.minFeeMultiplier+e.averageFeeMultiplier*.35;case h.Slowest:return e.minFeeMultiplier;case h.Default:default:return a.TX_FEE_MULTIPLIER_DEFAULT}}const O=new A;function G(e){return!!(e.startsWith("image/png")||e.startsWith("image/jpeg"))}function U(e){return!!e.startsWith("audio/mpeg")}function X(e){return!!e.startsWith("video/mp4")}function k(e){return!1}function L(e){if(e.length===0)return a.STR_NA;const t=e.match("^data:(.*?);base64,(.*)$");return(t==null?void 0:t.length)!==3?(O.error("get MIME from Base64","invalid base64 format.","32 characters from the beginning:",e.substring(0,32)),a.STR_NA):t[1]}var x=v();const _=new A;function b(e,t=a.CRYPTO_HASH_ALGORITHM){try{return x.createHash(t).update(e).digest("hex")}catch(o){_.error("crypto:","create hash failed",o)}}function j(e,t,o=a.CRYPTO_CHIPER_ALGORITHM,s=a.CRYPTO_IV_DEFAULT){try{const c=x.createCipheriv(o,s,t),u=c.update(JSON.stringify(e)),r=y.Buffer.concat([u,c.final()]);return r.toString("hex",0,r.length)}catch(c){_.error("crypto:","crypto header failed",c)}}function M(e,t,o=a.CRYPTO_CHIPER_ALGORITHM,s=a.CRYPTO_IV_DEFAULT){try{const c=y.Buffer.from(e,"hex"),u=x.createDecipheriv(o,s,t),r=u.update(c),n=y.Buffer.concat([r,u.final()]);return JSON.parse(n.toString())}catch(c){_.error("crypto:","decrypto header failed",c)}}const T=C(),g=R();async function Y(e){const t="announce tx:";if(typeof g.txRepo>"u"){T.logger.error(t,"repository undefined.");return}return e.type===i.TransactionType.AGGREGATE_BONDED?await g.txRepo.announceAggregateBonded(e).toPromise():await g.txRepo.announce(e).toPromise()}async function w(e){const t="get tx info:";if(typeof g.txRepo>"u"){T.logger.error(t,"repository undefined.");return}return await g.txRepo.getTransaction(e,i.TransactionGroup.Confirmed).toPromise()}async function P(e,t,o){const s={type:t,address:e,group:i.TransactionGroup.Confirmed,pageSize:100,pageNumber:1};return typeof o<"u"&&(s.fromHeight=o),await I(s)}async function I(e){const t="search txes:";if(T.logger.debug(t,"start","page:",e.pageNumber||a.STR_NA),typeof g.txRepo>"u")return T.logger.error(t,"repository undefined."),[];const o=await g.txRepo.search(e).toPromise();return typeof o>"u"?(T.logger.error(t,"search failed."),[]):o.isLastPage?o.data:(e.pageNumber=typeof e.pageNumber>"u"?2:e.pageNumber+1,o.data.concat(await I(e)))}function q(e,t){return i.TransferTransaction.create(i.Deadline.create(g.epochAdjustment),e.address,[],i.PlainMessage.create(t),g.networkType)}function W(e,t=a.TX_FEE_MULTIPLIER_DEFAULT){return i.HashLockTransaction.create(i.Deadline.create(g.epochAdjustment),new i.Mosaic(new i.NamespaceId(a.TX_XYM_ALIAS),i.UInt64.fromUint(a.TX_HASHLOCK_COST)),i.UInt64.fromUint(480),e,g.networkType).setMaxFee(t)}function V(e,t=a.TX_FEE_MULTIPLIER_DEFAULT){return i.AggregateTransaction.createBonded(i.Deadline.create(g.epochAdjustment),e,g.networkType,[]).setMaxFeeForAggregate(t,0)}function $(e,t=a.TX_FEE_MULTIPLIER_DEFAULT){return i.AggregateTransaction.createComplete(i.Deadline.create(g.epochAdjustment),e,g.networkType,[]).setMaxFeeForAggregate(t,0)}const d=new A;async function z(e){const t="get EternalBookProtocol data:";d.debug(t,"start");const o=await P(e.ownerAddress,[i.TransactionType.AGGREGATE_COMPLETE,i.TransactionType.AGGREGATE_BONDED],e.startHeight);if(o.length===0)return d.debug(t,"not exist EternalBookProtocol data"),[];const s=[];for(let r=0;r<o.length;r++){const n=o[r];if(typeof n.transactionInfo>"u"||typeof n.transactionInfo.hash>"u"){d.error(t,"aggregate tx hash undefined."),d.debug(t,"aggregate tx:",n);continue}const f=await w(n.transactionInfo.hash);if(typeof f>"u"){d.error(t,"get aggregate tx info failed.",n.transactionInfo.hash);continue}if(f.innerTransactions.length===0){d.debug(t,"inner tx none.",n.transactionInfo.hash);continue}const m=f.innerTransactions.filter(l=>l.type===i.TransactionType.TRANSFER&&e.ownerAddress.equals(l.recipientAddress));if(f.innerTransactions.length!==m.length){d.debug(t,"all inner tx are not transfer.",n.transactionInfo.hash);continue}const p=M(f.innerTransactions[a.TX_HEADER_IDX].message.payload,e.id.toHex());if(typeof p>"u"){d.debug(t,"header decrypt failed.",n.transactionInfo.hash);continue}if(p.version.substring(0,a.PROTOCOL_NAME.length)!==a.PROTOCOL_NAME){d.debug(t,"header validate:","invalid protocol.",n.transactionInfo.hash);continue}if(e.id.toHex()!==p.mosaicId||e.ownerAddress.plain()!==p.address){d.debug(t,"header validate:","invalid mosaic.",n.transactionInfo.hash);continue}s.push({header:p,aggregateTx:f})}if(s.length===0)return d.error(t,"not exist on chain data."),[];const c=s.filter(r=>"hash"in r.header);d.debug(t,"last aggregate tx list:",c);const u=[];for(let r=0;r<c.length;r++){const n=c[r];if(typeof n.aggregateTx.transactionInfo>"u"||typeof n.aggregateTx.transactionInfo.timestamp>"u"){d.error(t,"aggregate tx info undefined."),d.debug(t,"aggregate tx:",n.aggregateTx);continue}const f=R(),m=S(f.epochAdjustment,n.aggregateTx.transactionInfo.timestamp),p=new Date(m),l=D(s,n),E=b(l.data);typeof E<"u"&&E===n.header.hash?u.push({title:l.title,description:l.description||a.STR_NA,date:p,mime:L(l.data),base64:l.data}):d.debug(t,"hash incorrect.",n.aggregateTx)}return u}function D(e,t){const o="get on chain data:";let s="";for(let r=a.TX_DATA_IDX;r<t.aggregateTx.innerTransactions.length;r++)s+=t.aggregateTx.innerTransactions[r].message.payload;if(t.header.prevTx===null)return{data:s,title:t.header.title||a.STR_NA,description:t.header.description||a.STR_NA};const c=e.filter(r=>typeof r.aggregateTx.transactionInfo<"u"&&t.header.prevTx===r.aggregateTx.transactionInfo.hash);if(c.length===0)return d.debug(o,"not exist prev aggregate tx."),{data:s,title:t.header.title||a.STR_NA,description:t.header.description||a.STR_NA};1<c.length&&d.debug(o,"prev aggregate tx duplicate!");const u=D(e,c[0]);return u.data+=s,u}function J(e,t,o,s,c,u){const r=c||"",n={version:a.PROTOCOL_NAME+" "+a.PROTOCOL_VERSION,mosaicId:e,address:t,prevTx:r.length>0?r:null};return r.length===0&&(n.multipul=!0,n.title=o,n.description=s),typeof u<"u"&&u.length>0&&(n.hash=u),n}export{S as C,U as a,F as b,k as c,X as d,B as e,L as f,z as g,H as h,G as i,V as j,$ as k,Y as l,W as m,J as n,b as o,j as p,q};
