import{C as o,v as p,l as L,f as R,e as a,x as O,y as v,z as T}from"./index-0e0f16ca.js";function F(e){return e?"true":"false"}function H(e){return e.toLocaleString("en")}function C(e,t){return e*1e3+Number(t.toString())}function x(e,t){switch(t){case p.Fast:return e.averageFeeMultiplier;case p.Average:return e.minFeeMultiplier+e.averageFeeMultiplier*.65;case p.Slow:return e.minFeeMultiplier+e.averageFeeMultiplier*.35;case p.Slowest:return e.minFeeMultiplier;case p.Default:default:return o.TX_FEE_MULTIPLIER_DEFAULT}}const l=L(),s=R();async function N(e){const t="announce tx:";if(typeof s.txRepo>"u"){l.logger.error(t,"repository undefined.");return}return e.type===a.TransactionType.AGGREGATE_BONDED?await s.txRepo.announceAggregateBonded(e).toPromise():await s.txRepo.announce(e).toPromise()}async function S(e){const t="get tx info:";if(typeof s.txRepo>"u"){l.logger.error(t,"repository undefined.");return}return await s.txRepo.getTransaction(e,a.TransactionGroup.Confirmed).toPromise()}async function G(e,t,n){const i={type:t,address:e,group:a.TransactionGroup.Confirmed,pageSize:100,pageNumber:1};return typeof n<"u"&&(i.fromHeight=n),await I(i)}async function I(e){const t="search txes:";if(l.logger.debug(t,"start","page:",e.pageNumber||o.STR_NA),typeof s.txRepo>"u")return l.logger.error(t,"repository undefined."),[];const n=await s.txRepo.search(e).toPromise();return typeof n>"u"?(l.logger.error(t,"search failed."),[]):n.isLastPage?n.data:(e.pageNumber=typeof e.pageNumber>"u"?2:e.pageNumber+1,n.data.concat(await I(e)))}function U(e,t){return a.TransferTransaction.create(a.Deadline.create(s.epochAdjustment),e.address,[],a.PlainMessage.create(t),s.networkType)}function B(e,t=o.TX_FEE_MULTIPLIER_DEFAULT){return a.HashLockTransaction.create(a.Deadline.create(s.epochAdjustment),new a.Mosaic(new a.NamespaceId(o.TX_XYM_ALIAS),a.UInt64.fromUint(o.TX_HASHLOCK_COST)),a.UInt64.fromUint(480),e,s.networkType).setMaxFee(t)}function X(e,t=o.TX_FEE_MULTIPLIER_DEFAULT){return a.AggregateTransaction.createBonded(a.Deadline.create(s.epochAdjustment),e,s.networkType,[]).setMaxFeeForAggregate(t,0)}function k(e,t=o.TX_FEE_MULTIPLIER_DEFAULT){return a.AggregateTransaction.createComplete(a.Deadline.create(s.epochAdjustment),e,s.networkType,[]).setMaxFeeForAggregate(t,0)}var h=O();const y=new v;function j(e,t=o.CRYPTO_HASH_ALGORITHM){try{return h.createHash(t).update(e).digest("hex")}catch(n){y.error("crypto:","create hash failed",n)}}function Y(e,t,n=o.CRYPTO_CHIPER_ALGORITHM,i=o.CRYPTO_IV_DEFAULT){try{const r=h.createCipheriv(n,i,t),c=r.update(JSON.stringify(e)),d=T.Buffer.concat([c,r.final()]);return d.toString("hex",0,d.length)}catch(r){y.error("crypto:","crypto header failed",r)}}function M(e,t,n=o.CRYPTO_CHIPER_ALGORITHM,i=o.CRYPTO_IV_DEFAULT){try{const r=T.Buffer.from(e,"hex"),c=h.createDecipheriv(n,i,t),d=c.update(r),f=T.Buffer.concat([d,c.final()]);return JSON.parse(f.toString())}catch(r){y.error("crypto:","decrypto header failed",r)}}const u=new v;function V(e,t,n,i,r,c){const d=r||"",f={version:o.PROTOCOL_NAME+" "+o.PROTOCOL_VERSION,mosaicId:e,address:t,prevTx:d.length>0?d:null};return d.length===0&&(f.multipul=!0,f.title=n,f.description=i),typeof c<"u"&&c.length>0&&(f.hash=c),f}function b(e,t){const n="validate inner tx:";if(e.innerTransactions.length===0)return u.debug(n,"inner tx none.",e.transactionInfo),!1;const i=e.innerTransactions.filter(r=>r.type===a.TransactionType.TRANSFER&&t.equals(r.recipientAddress));return e.innerTransactions.length!==i.length?(u.debug(n,"exist not transfer.",e.transactionInfo),!1):!0}function w(e,t){const n="validate protocol header:";return e.version.substring(0,o.PROTOCOL_NAME.length)!==o.PROTOCOL_NAME?(u.debug(n,"invalid protocol.",e),!1):t.id.toHex()!==e.mosaicId||t.ownerAddress.plain()!==e.address?(u.debug(n,"invalid mosaic.",e),!1):!0}async function z(e,t){var A,E,_;const n="get fragment:";if(typeof((A=e==null?void 0:e.transactionInfo)==null?void 0:A.hash)>"u"){u.debug(n,"tx hash undefined.",e);return}const i=await S(e.transactionInfo.hash);if(typeof((E=i==null?void 0:i.transactionInfo)==null?void 0:E.hash)>"u"){u.debug(n,"tx info hash undefined.",e);return}if(i.type!==a.TransactionType.AGGREGATE_COMPLETE&&i.type!==a.TransactionType.AGGREGATE_BONDED){u.debug(n,"tx is not aggregate.",e);return}const r=i;if(!b(r,t.ownerAddress)){u.debug(n,"aggregate tx inner invalid.",r);return}const c=M(r.innerTransactions[o.TX_HEADER_IDX].message.payload,t.id.toHex());if(typeof c>"u"){u.debug(n,"header decrypt failed.",r.transactionInfo);return}if(!w(c,t)){u.debug(n,"aggregate tx header invalid.",e);return}if(typeof((_=e.transactionInfo)==null?void 0:_.timestamp)>"u"){u.debug(n,"aggregate tx info timestamp undefined.");return}const d=R(),f=C(d.epochAdjustment,e.transactionInfo.timestamp),D=new Date(f);let m="";for(let g=o.TX_DATA_IDX;g<r.innerTransactions.length;g++)m+=r.innerTransactions[g].message.payload;return{hash:e.transactionInfo.hash,timestamp:D,header:c,data:m}}export{C,z as a,j as b,F as c,x as d,H as e,X as f,G as g,k as h,N as i,B as j,V as k,Y as l,U as m};
